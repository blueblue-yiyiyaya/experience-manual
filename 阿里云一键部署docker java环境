#!/bin/bash

# 安装 Docker
if command -v yum &> /dev/null; then
    echo "安装 Docker (CentOS/Alibaba Cloud Linux)"
    sudo yum install -y yum-utils
    # 安装 阿里云镜像
    sudo tee /etc/yum.repos.d/docker-ce.repo <<-'EOF'
    [docker-ce-stable]
    name=Docker CE Stable - $basearch
    baseurl=https://mirrors.aliyun.com/docker-ce/linux/centos/$releasever/$basearch/stable
    enabled=1
    gpgcheck=1
    gpgkey=https://mirrors.aliyun.com/docker-ce/linux/centos/gpg
    EOF
    sudo yum install -y docker-ce docker-ce-cli containerd.io
elif command -v apt &> /dev/null; then
    echo "安装 Docker (Ubuntu)"
    sudo apt update
    sudo apt install -y apt-transport-https ca-certificates curl software-properties-common
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
    sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
    sudo apt update
    sudo apt install -y docker-ce docker-ce-cli containerd.io
else
    echo "不支持的包管理器"
    exit 1
fi

# 启动 Docker
sudo systemctl start docker
sudo systemctl enable docker

# 安装 OpenJDK 17
if command -v yum &> /dev/null; then
    echo "安装 OpenJDK 17"
    sudo yum install -y java-17-openjdk java-17-openjdk-devel
elif command -v apt &> /dev/null; then
    echo "安装 OpenJDK 17"
    sudo apt install -y openjdk-17-jdk
fi

# 配置 JAVA_HOME
JAVA_PATH=$(dirname $(dirname $(readlink -f $(which java))))
echo "export JAVA_HOME=$JAVA_PATH" | sudo tee /etc/profile.d/java.sh
source /etc/profile.d/java.sh

echo "安装完成！"
echo "Java 版本: $(java -version 2>&1 | head -n 1)"
echo "Docker 版本: $(docker --version)"
